<link rel="import" href="../bower_components/core-elements/core-elements.html">
<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="weighty-app" attributes="datasetList isDatasetListSyncing">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <core-animated-pages fit selected="{{ page }}">
        <dataset-selector-page fit name="selector"
            datasetList="{{ datasetList }}" datasetId="{{ datasetId }}"
            isLoading="{{ isDatasetListSyncing }}"
        ></dataset-selector-page>
        <dataset-page fit name="dataset"
            weightyDataset="{{ weightyDataset }}" isLoading="{{ loadingDataset }}"
            on-back="{{ back }}"></dataset-page>
    </core-animated-pages>
  </template>
  <script>
    Polymer({
        page: 'selector',

        back: function() {
            this.datasetId = null;
        },

        ready: function() {
            var self = this;
            this.parseLocation();
            window.addEventListener('popstate', function() { self.parseLocation(); });
        },

        dataSourceChanged: function() {
            if(!this.dataSource) { return; }
            this.refreshDataset();
            this.refreshDatasetList();
        },

        refreshDataset: function() {
            var self = this;
            this.dataset = null;
            if(!this.dataSource || !this.datasetId) { return; }

            this.loadingDataset = true;
            this.dataSource.createDatasetPromise(this.datasetId)
                .then(function(dataset) {
                    self.loadingDataset = false;
                    if(!dataset || (dataset.id !== self.datasetId)) { return; }
                    console.log('Retrieved dataset', dataset);
                    self.weightyDataset = dataset;
                });
        },

        refreshDatasetList: function() {
            var self = this;
            this.datasetList = null;
            if(!this.dataSource) { return; }

            this.loadingDatasetList = true;
            this.dataSource.createDatasetListPromise()
                .then(function(datasetList) {
                    self.loadingDatasetList = false;
                    if(!datasetList) { return; }
                    console.log('Retrieved list', datasetList);
                    self.datasetList = datasetList;
                });
        },

        datasetIdChanged: function() {
            this.refreshDataset();

            if(this.datasetId && (this.page !== 'dataset')) {
                this.page = 'dataset';
                history.pushState(null, null, '#/dataset/' + this.datasetId);
            } else if(!this.datasetId && (this.page !== 'selector')) {
                this.page = 'selector';
                history.pushState(null, null, '#');
            }
        },

        parseLocation: function() {
            console.log('parse location', window.location.hash);

            var datasetHashRe = /^#\/dataset\/([^\/]+)\/?$/;
            var rootHashRe = /^#\/?$/;

            if((window.location.hash === '') || (rootHashRe.test(window.location.hash))) {
                console.log('matches root');
                this.datasetId = null;
                return;
            }

            // work out if the hash fragment indicates we should show a
            // dataset or not
            var datasetMatch = datasetHashRe.exec(window.location.hash);
            if(datasetMatch) {
                console.log('matches dataset', datasetMatch[1]);
                this.datasetId = datasetMatch[1];
                this.page = 'dataset';
                return;
            }
        },
    });
  </script>
</polymer-element>
