<link rel="import" href="../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../bower_components/core-elements/core-elements.html">
<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="dataset-page" attributes="weightyDataset isLoading">
  <template>
    <style>
      :host {
        display: block;
      }
      #container { overflow: auto; }
    </style>

    <dataset-stats id="stats" weightyDataset="{{ weightyDataset }}"></dataset-stats>

    <div fit id="container" vertical layout>
        <template if="{{ isLoading }}">
            <div fit vertical layout center-justified>
                <div self-center>
                    <loading-throbber></loading-throbber>
                </div>
            </div>
        </template>
        <template if="{{ !isLoading &amp;&amp; weightyDataset }}">
            <core-header-panel flex>
                <core-toolbar>
                    <paper-icon-button icon="arrow-back" on-tap="{{back}}"></paper-icon-button>
                    <div flex>{{ weightyDataset.file.title }}</div>
                </core-toolbar>
                <div content vertical layout>
                    <template bind="{{ $.stats }}">
                        <div id="headlineStats">
                            {{ latestDatum.weight }} kg
                            {{ earliestDatum.weight - latestDatum.weight }} /
                                {{ earliestDatum.weight - idealWeight }} kg
                        </div>
                    </template>
                    <div id="chart">
                        <highcharts-chart>
                        <highcharts-series>
                                <template repeat="{{ weightyDataset.data }}">
                                    <highcharts-datum x="{{ timestamp }}" y="{{ weight }}"
                                    ></highcharts-datum>
                                </template>
                            </highcharts-series>
                        </highcharts-chart>
                    </div>
                </div>
            </core-header-panel>
        </template>
    </div>
  </template>
  <script>
    Polymer({
        isLoading: false,
        back: function() { this.fire('back'); },
    });
  </script>
</polymer-element>

<polymer-element name="dataset-stats" attributes="weightyDataset" hidden>
  <script>(function(){
    var IDEAL_BMI = 22;

    var bmi2weight = function(bmi, height) { return bmi * height * height; };
    var weight2bmi = function(weight, height) { return weight / (height * height); }

    Polymer({
        ready: function() {
            this.weightyDatasetChanged();
        },

        weightyDatasetChanged: function() {
            this.reset_();
            if(!this.weightyDataset) { return; }

            var data = this.weightyDataset.data,
                file = this.weightyDataset.file,
                metadata = null;

            if(file && file.properties) {
                file.properties.forEach(function(prop) {
                    if(prop.key === 'weightyMetadata') {
                        metadata = JSON.parse(prop.value);
                    }
                });
            }

            if(metadata && (+metadata.height === metadata.height)) {
                this.idealWeight = bmi2weight(IDEAL_BMI, metadata.height);
            }

            if(data && (data.length !== 0)) {
                this.latestDatum = data[data.length-1];
                this.earliestDatum = data[0];
                console.log(file);
            }
        },

        reset_: function() {
            this.latestDatum = null;
            this.earliestDatum = null;
            this.idealWeight = null;
        },
    });
  })();</script>
</polymer-element>
