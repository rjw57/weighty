<link rel="import" href="../bower_components/google-apis/google-apis.html">
<link rel="import" href="../bower_components/google-signin/google-signin.html">
<link rel="import" href="../bower_components/polymer-filters/polymer-filters.html">
<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="grid-layout.html">
<link rel="import" href="dataset-sheet.html">

<polymer-element name="dataset-list"
    on-google-signin-aware-success="{{ signedIn }}"
    on-google-signin-aware-signed-out="{{ signedOut }}">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <google-signin-aware
      id="signin" scopes="https://www.googleapis.com/auth/drive"
    ></google-signin-aware>

    <grid-layout cascade fade>
      <template repeat="{{ dataset in datasets }}">
        <div name="{{ dataset.id }}" hero hero-id="{{ dataset.id }}">
          <dataset-sheet>
            <div title>{{ dataset.title }}</div>
            <div subtitle>{{ dataset.modifiedDate | parseDate | date('yyyy-MM-dd') }}</div>
            <paper-ripple fit></paper-ripple>
          </dataset-sheet>
        </div>
      </template>
    </grid-layout>
  </template>
  <script>
    Polymer({
      // Attributes
      selected: null,

      // Properties
      authData: null,
      datasets: [],

      // Observers
      observe: {
        authData: 'refresh',
      },

      // Filters
      parseDate: function(value) {
        return new Date(value);
      },

      // Event handlers
      signedIn: function(event, authData) {
        this.authData = authData;
      },

      signedOut: function() {
        this.authData = null;
      },

      refresh: function() {
        var self = this;

        // If auth data is null, just clear dataset list
        if(this.authData === null) {
          self.datasets = [];
          self.selected = null;

          self.fire('dataset-list-changed');
          return;
        }

        // Otherwise, kick off the dataset API call...

        // how to find weighty files
        var searchQuery = 'not trashed and properties has ' +
          '{ key = \'weightyVersion\' and value = \'2\' and visibility=\'PUBLIC\'}';

        // kick off query
        gapi.client.load('drive', 'v2', function() {
          var drive = gapi.client.drive;
          drive.files.list({ q: searchQuery }).execute(function(data) {
            console.log('datasets query returned', data);

            if(data.kind !== 'drive#fileList') {
              // There was an error!
              return;
            }

            self.datasets = data.items;
            self.selected = null;

            self.fire('dataset-list-changed');
          });
        });
      },
    });
  </script>
</polymer-element>
