<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="dataset-list" attributes="datasets">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <google-signin-aware id="signin" scopes="https://www.googleapis.com/auth/drive"
      on-google-signin-aware-success="{{ signedIn }}"
      on-google-signin-aware-signed-out="{{ signedOut }}">
    ></google-signin-aware>
  </template>

  <script>
    Polymer({
      authData: null,

      observe: {
        authData: 'refresh',
      },

      signedIn: function(event, detail) { this.authData = detail; },
      signedOut: function() { this.authData = null; },

      refresh: function() {
        var self = this;
        console.log('Refreshing datasets...');

        // If auth data is null, just clear dataset list
        if(this.authData === null) {
          self.datasets = [];
          return;
        }

        // Otherwise, kick off the dataset API call...

        // how to find weighty files
        var searchQuery = 'not trashed and properties has ' +
          '{ key = \'weightyVersion\' and value = \'2\' and visibility=\'PUBLIC\'}';

        // kick off query
        self.fire('dataset-list-refresh-start');
        gapi.client.load('drive', 'v2', function() {
          var drive = gapi.client.drive;
          drive.files.list({ q: searchQuery }).execute(function(data) {
            self.fire('dataset-list-refresh-end');

            console.log('datasets query returned', data);

            if(data.kind !== 'drive#fileList') {
              // There was an error!
              return;
            }

            self.datasets = [];
            data.items.forEach(function(item) {
              self.datasets.push({
                id: item.id,
                title: item.title,
                modifiedDate: new Date(item.modifiedDate),
              });
            });
          });
        });
      },
    });
  </script>
</polymer-element>
