<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="weighty-datasource" hidden attributes="datasets datasetId weightyDataset">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <google-api-promise id="drive" name="drive" version="v2"></google-api-promise>
    <google-api-promise id="fusiontables" name="fusiontables" version="v1"></google-api-promise>
    <google-auth-promise id="auth"
        scopes="https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/fusiontables"
    ></google-auth-promise>
  </template>
  <script>
    Polymer({
        ready: function() {
            // set the various API promises
            this.drive = this.$.drive.api;
            this.fusiontables = this.$.fusiontables.api;
            this.auth = this.$.auth.auth;

            // Convenience promise to return an object with apis and auth data
            this.apis = Promise.all([this.drive, this.fusiontables, this.auth])
                .then(function(apis) {
                    return { drive: apis[0], fusiontables: apis[1], auth: apis[2] };
                });

            this.refresh();
        },

        // kick of request to drive API for datasets
        refresh: function() {
            var self = this;
            this.newDatasetListPromise().then(function(items) {
                self.datasets = items;
            });
        },

        datasetIdChanged: function() {
            // handle early outs
            if(!this.datasetId && this.weightyDataset) {
                this.weightyDataset = null;
                return;
            } else if(this.weightyDataset && this.dataset.id === this.datasetId) {
                return;
            }

            // otherwise, populate dataset after a bit of a delay to simulate
            // network.
            this.weightyDataset = null;
            this.async(function() {
                this.weightyDataset = {
                    id: this.datasetId,
                    title: 'funky test dataset (' + this.datasetId + ')',
                };
            }, null, 1500);
        },

        weightyDatasetChanged: function() {
            console.log('dataset', this.weightyDataset);
            if(!this.weightyDataset) {
                this.datasetId = null;
                return;
            }
            this.datasetId = this.weightyDataset.id;
        },

        // Return a promise which starts a query for all user datasets and is resolved with
        // a list of dataset entries.
        newDatasetListPromise: function() {
            // how to find weighty files
            var searchQuery =
                'not trashed and properties has ' +
                '{ key = \'weightyVersion\' and value = \'2\' and visibility=\'PUBLIC\'}';

            return this.apis.then(function(client) {
                var req = client.drive.files.list({ q: searchQuery });
                return new Promise(function(resolve, reject) {
                    req.execute(function(data) {
                        console.log('drive.files.list reply', data);

                        if(data.kind !== 'drive#fileList') {
                            reject(new Error('Got unexpected reply from Drive API'));
                            return;
                        }

                        var items = [];
                        data.items.forEach(function(file) {
                            items.push({
                                id: file.id, title: file.title,
                                modifiedDate: new Date(file.modifiedDate),
                                createdDate: new Date(file.createdDate),
                            });
                        });

                        resolve(items);
                    });
                });
            });
        },
    });
  </script>
</polymer-element>
