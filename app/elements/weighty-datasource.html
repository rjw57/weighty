<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="weighty-datasource" hidden attributes="datasets datasetId weightyDataset"
    on-weighty-dataset-request="{{ datasetRequest }}">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <google-api-promise id="drive" name="drive" version="v2"></google-api-promise>
    <google-api-promise id="fusiontables" name="fusiontables" version="v1"></google-api-promise>
    <google-auth-promise id="auth"
        scopes="https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/fusiontables"
    ></google-auth-promise>
  </template>
  <script>
    Polymer({
        ready: function() {
            // set the various API promises
            this.drive = this.$.drive.api;
            this.fusiontables = this.$.fusiontables.api;
            this.auth = this.$.auth.auth;

            // Convenience promise to return an object with apis and auth data
            this.apis = Promise.all([this.drive, this.fusiontables, this.auth])
                .then(function(apis) {
                    return { drive: apis[0], fusiontables: apis[1], auth: apis[2] };
                });

            this.refresh();
        },

        // kick of request to drive API for datasets
        refresh: function() {
            var self = this;
            this.newDatasetListPromise().then(function(items) {
                self.datasets = items;
            });
        },

        datasetIdChanged: function() {
            var self = this;

            // handle early outs
            if(!this.datasetId && this.weightyDataset) {
                this.weightyDataset = null;
                return;
            } else if(this.weightyDataset && this.dataset.id === this.datasetId) {
                return;
            }

            // otherwise, populate dataset
            this.weightyDataset = null;
            this.newValidateDatasetIdPromise(this.datasetId).then(function(objs) {
                console.log('id validates:', objs.file.id);
                return self.newGetDataPromise(objs.file.id).then(function(data) {
                    self.weightyDataset = {
                        id: objs.file.id,
                        file: objs.file,
                        table: objs.table,
                        data: data,
                    };
                });
            }).catch(function(err) {
                console.log('Error validating data');
                console.log(err);
            });
        },

        weightyDatasetChanged: function() {
            console.log('dataset', this.weightyDataset);
            if(!this.weightyDataset) {
                this.datasetId = null;
                return;
            }
            this.datasetId = this.weightyDataset.id;
        },

        newGetDataPromise: function(trustedId) {
            return this.apis.then(function(client) {
                console.log('Fetching data for', trustedId);
                var req = client.fusiontables.query.sqlGet({
                    sql: 'SELECT Timestamp, Weight FROM ' + trustedId + ' ORDER BY Timestamp',
                });
                return new Promise(function(resolve, reject) { req.execute(function(data) {
                    console.log('Fetch returned', data);
                    if(data.kind !== 'fusiontables#sqlresponse') {
                        reject(new Error('Unexpected response from fusiontables API'));
                        return;
                    }

                    var weights = [];
                    data.rows.forEach(function(row) {
                        weights.push({
                            timestamp: +row[0],         // Number
                            weight: +row[1],            // Number
                            date: new Date(+row[0]),
                        });
                    });
                    resolve(weights);
                }); });
            });
        },

        // Convenience method to construct a verification promise which verifies id
        // via drive and fusion table API.
        newValidateDatasetIdPromise: function(untrustedId) {
            return Promise.all([
                this.newDatasetFetchViaDrivePromise(untrustedId),
                this.newDatasetFetchViaFusionTablesPromise(untrustedId),
            ]).then(function(data) {
                return { file: data[0], table: data[1] };
            });
        },

        // Return a promise which uses the drive API to return details on a dataset. This
        // can safely be passed an untrusted id for verification.
        newDatasetFetchViaDrivePromise: function (untrustedId) {
            return this.apis.then(function(client) {
                var req = client.drive.files.get({ fileId: untrustedId });
                return new Promise(function(resolve, reject) { req.execute(function(data) {
                    console.log('fetch dataset via drive returns', data);

                    if(!data || !data.properties) {
                        reject(new Error('Unexpected response from drive API'));
                        return;
                    }

                    var isValid = false;

                    data.properties.forEach(function(property) {
                        if(property.key !== 'weightyVersion' || property.value !== '2') { return; }
                        isValid = true;
                    });

                    if(!isValid) {
                        reject(new Error('Invalid id'));
                        return;
                    }

                    resolve(data);
                }); });
            });
        },

        // Return a promise which uses the fusiontables API to return details on a dataset. This
        // can safely be passed an untrusted id for verification.
        newDatasetFetchViaFusionTablesPromise: function (untrustedId) {
            return this.apis.then(function(client) {
                var req = client.fusiontables.table.get({ tableId: untrustedId });
                return new Promise(function(resolve, reject) { req.execute(function(data) {
                    if(!data || !data.columns) {
                        reject(new Error('Unexpected response from tables API'));
                        return;
                    }

                    var hasWeight = false, hasTimestamp = false;

                    data.columns.forEach(function(column) {
                        if(column.name === 'Weight' && column.type === 'NUMBER') {
                            hasWeight = true;
                        } else if(column.name === 'Timestamp' && column.type === 'NUMBER') {
                            hasTimestamp = true;
                        }
                    });

                    if(!hasWeight || !hasTimestamp) {
                        reject(new Error('Invalid id'));
                        return;
                    }

                    resolve(data);
                }); });
            });
        },

        // Return a promise which starts a query for all user datasets and is resolved with
        // a list of dataset entries.
        newDatasetListPromise: function() {
            // how to find weighty files
            var searchQuery =
                'not trashed and properties has ' +
                '{ key = \'weightyVersion\' and value = \'2\' and visibility=\'PUBLIC\'}';

            return this.apis.then(function(client) {
                var req = client.drive.files.list({ q: searchQuery });
                return new Promise(function(resolve, reject) {
                    req.execute(function(data) {
                        console.log('drive.files.list reply', data);

                        if(data.kind !== 'drive#fileList') {
                            reject(new Error('Got unexpected reply from Drive API'));
                            return;
                        }

                        var items = [];
                        data.items.forEach(function(file) {
                            items.push({
                                id: file.id, title: file.title,
                                modifiedDate: new Date(file.modifiedDate),
                                createdDate: new Date(file.createdDate),
                            });
                        });

                        resolve(items);
                    });
                });
            });
        },
    });
  </script>
</polymer-element>
