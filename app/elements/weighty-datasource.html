<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="weighty-datasource" hidden attributes="datasets datasetId weightyDataset">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <google-api-promise id="drive" name="drive" version="v2"></google-api-promise>
    <google-api-promise id="fusiontables" name="fusiontables" version="v1"></google-api-promise>
    <google-auth-promise id="auth"
        scopes="https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/fusiontables">
  </template>
  <script>
    Polymer({
        ready: function() {
            // set the various API promises
            this.drive = this.$.drive.api;
            this.fusiontables = this.$.fusiontables.api;
            this.auth = this.$.auth.auth;

            // Convenience promise to return an object with apis and auth data
            this.apis = Promise.all([this.drive, this.fusiontables, this.auth])
                .then(function(apis) {
                    return { drive: apis[0], fusiontables: apis[1], auth: apis[2] };
                });

            // populate datasets after a delay to simulate network
            this.async(function() {
                this.datasets = [
                    {
                        id: 'xxxx', title: 'fooobar',
                        modifiedDate: new Date(Date.now()),
                        createdDate: new Date(Date.now() - 30*24*60*60*1000),
                    },
                    {
                        id: 'xggg', title: 'Another dataset',
                        modifiedDate: new Date(Date.now() - 40*24*60*60*1000),
                        createdDate: new Date(Date.now() - 80*24*60*60*1000),
                    },
                    {
                        id: 'kdlmgls', title: 'Some more',
                        modifiedDate: new Date(Date.now() - 20*24*60*60*1000),
                        createdDate: new Date(Date.now() - 30*24*60*60*1000),
                    },
                ];
            }, null, 1000);

            this.apis.then(function(apis) {
                console.log(apis);
            });
        },

        datasetIdChanged: function() {
            // handle early outs
            if(!this.datasetId && this.weightyDataset) {
                this.weightyDataset = null;
                return;
            } else if(this.weightyDataset && this.dataset.id === this.datasetId) {
                return;
            }

            // otherwise, populate dataset after a bit of a delay to simulate
            // network.
            this.weightyDataset = null;
            this.async(function() {
                this.weightyDataset = {
                    id: this.datasetId,
                    title: 'funky test dataset (' + this.datasetId + ')',
                };
            }, null, 1500);
        },

        weightyDatasetChanged: function() {
            console.log('dataset', this.weightyDataset);
            if(!this.weightyDataset) {
                this.datasetId = null;
                return;
            }
            this.datasetId = this.weightyDataset.id;
        },
    });
  </script>
</polymer-element>
