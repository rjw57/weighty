"use strict";angular.module("webappApp",["ngCookies","ngResource","ngSanitize","ngRoute","googleOauth","mobile-angular-ui","mobile-angular-ui.touch","mobile-angular-ui.scrollable"]).config(["$routeProvider","$locationProvider","TokenProvider",function(a,b,c){a.when("/",{templateUrl:"views/root.html"}).when("/dataset/:sheetId",{templateUrl:"views/dataset.html",controller:"DatasetCtrl"}).when("/datasets",{templateUrl:"views/datasetlist.html",controller:"DatasetListCtrl",active:"datasets"}).otherwise({redirectTo:"/"});var d=document.URL.split("#")[0];"/"===d[d.length-1]&&(d=d.substr(0,d.length-1)),c.extendConfig({clientId:"266506267940-nk8rt8rdrpb8l5j098ugl2v04m6evujn.apps.googleusercontent.com",redirectUri:d+"/oauth2callback.html",scopes:["https://www.googleapis.com/auth/plus.me","https://www.googleapis.com/auth/drive.file","https://spreadsheets.google.com/feeds"]})}]),angular.module("webappApp").controller("DatasetCtrl",["$scope","$routeParams","GoogleApi",function(a,b,c){var d=864e5,e="http://schemas.google.com/spreadsheets/2006#worksheetsfeed",f="https://spreadsheets.google.com/feeds/spreadsheets/",g="http://schemas.google.com/spreadsheets/2006#listfeed",h="alternate",i="http://schemas.google.com/spreadsheets/2006/extended";a.loaded=!1,a.loading=!1,b.sheetId&&(a.$watch("isSignedIn",function(){a.name="",a.targetWeight=100,a.targetDate=new Date,a.weights=[],a.loaded=!1,a.loading=!1,a.isSignedIn&&(a.loading=!0,c.get(f+b.sheetId,{responseType:"document"}).success(function(b){b=angular.element(b),a.name=b.find("title").text(),a.spreadsheetLinks={},angular.forEach(b.find("link"),function(b){b=angular.element(b),a.spreadsheetLinks[b.attr("rel")]=b.attr("href")})}).error(function(){a.loading=!1}))}),a.$watch("spreadsheetLinks",function(){a.spreadsheetLinks&&a.spreadsheetLinks[e]&&(a.spreadsheetViewLink=a.spreadsheetLinks[h],c.get(a.spreadsheetLinks[e],{responseType:"document"}).success(function(b){a.worksheets=[],angular.forEach(angular.element(b).find("entry"),function(b){var c={};b=angular.element(b),angular.forEach(b.find("link"),function(a){a=angular.element(a),c[a.attr("rel")]=a.attr("href")}),a.worksheets.push({links:c})})}).error(function(){a.loading=!1}))}),a.$watch("worksheets",function(){a.worksheets&&0!==a.worksheets.length&&c.get(a.worksheets[0].links[g],{responseType:"document"}).success(function(b){a.weights=[],angular.forEach(angular.element(b).find("entry"),function(b){var c,d,e;c=+angular.element(b.getElementsByTagNameNS(i,"timestamp")).text(),d=+angular.element(b.getElementsByTagNameNS(i,"weight")).text(),e=new Date(c),a.weights.push({date:e,weight:d}),a.loaded=!0,a.loading=!1})}).error(function(){a.loading=!1})}),a.$watch("weights",function(){if(a.goal=[],a.weights&&0!==a.weights.length){a.targetDate=new Date(a.weights[0].date.getTime()+100*d),a.startWeight=a.weights[0].weight,a.currentWeight=a.weights[a.weights.length-1].weight,a.progress=1-(a.currentWeight-a.targetWeight)/(a.startWeight-a.targetWeight);for(var b=a.weights[0].date.getTime(),c=a.targetDate.getTime(),e=Math.log(a.startWeight),f=Math.log(a.targetWeight),g=b;c>=g;g+=Math.min(d,(c-b)/100)){var h=(g-b)/(c-b);a.goal.push({date:new Date(g),weight:Math.exp(h*f+(1-h)*e)})}}}))}]),angular.module("webappApp").controller("NavCtrl",["$scope","$route","GoogleApi",function(a,b,c){a.me=null,a.$on("$routeChangeSuccess",function(){a.active=b.current.active}),a.$watch("accessToken",function(){return a.accessToken?void c.get("https://www.googleapis.com/plus/v1/people/me").success(function(b){a.me=b}):void(a.me=null)})}]),angular.module("webappApp").filter("weight",function(){return function(a){return a+"kg"}}),angular.module("webappApp").directive("waWeightGraph",function(){var a="#428bca",b="#5cb85c";return{template:"",restrict:"E",scope:{weights:"=weights",goal:"=goal"},link:function(c,d){var e=nv.models.lineChart().margin({left:50}).useInteractiveGuideline(!0).transitionDuration(350).showXAxis(!0).showYAxis(!0);e.xAxis.axisLabel("Date").showMaxMin(!1).tickFormat(function(a){return d3.time.format("%e %b %Y")(new Date(a))}),e.yAxis.axisLabel("Weight / kg").tickFormat(function(a){return d3.format(".0f")(a)+" kg"});var f=d3.select(d[0]).append("svg");nv.utils.windowResize(function(){e.update()});var g=function(){var d,g,h=[],i=[];for(g in c.weights)d=c.weights[g],h.push({x:d.date,y:d.weight});for(g in c.goal)d=c.goal[g],i.push({x:d.date,y:d.weight});f.datum([{values:i,key:"goal",color:b},{values:h,key:"weight",color:a}]).call(e)};c.$watch("weights",g),c.$watch("goal",g)}}}),angular.module("webappApp").directive("waProgressBar",function(){return{restrict:"E",templateUrl:"waprogressbar.html",scope:{min:"@",max:"@",value:"@"}}}),angular.module("webappApp").directive("waNav",function(){return{templateUrl:"wanav.html",restrict:"E"}}),angular.module("webappApp").service("GoogleApi",["$http","$q","$rootScope","Token",function(a,b,c,d){var e=function(){this.accessToken=null,this.expiryDate=null,d.get()&&this._verifyTokenAsync(d.get()),c.$broadcast("googleApiStateChanged")},f=function(a){var c=b.defer();return console.log("Asked to verify:",a),a?d.verifyAsync(a).then(function(b){console.log("Token verification succeeded:",b),c.resolve(angular.extend({accessToken:a},b))},function(a){c.reject(a)}):c.reject(),c.promise};return e.prototype._verifyTokenAsync=function(a){var b=this;f(a).then(function(e){b.accessToken=e.accessToken,b.expiryDate=new Date(Date.now()+1e3*e.expires_in),d.set(a),c.$broadcast("googleApiStateChanged"),console.log("New token set with expiry date:",b.expiryDate)},function(){b.accessToken=null,b.expiryDate=null,d.clear(),c.$broadcast("googleApiStateChanged")})},e.prototype.login=function(){var a=this,c=b.defer();return d.getTokenByPopup().then(function(b){a._verifyTokenAsync(b.access_token)},function(a){c.reject(a)}),c.promise},e.prototype.logout=function(){this.accessToken=null,this.expiresIn=null,d.clear(),c.$broadcast("googleApiStateChanged")},e.prototype.tokenHasExpired=function(){return Date.now()>=this.expiryDate.getTime()},e.prototype.isSignedIn=function(){return!!this.accessToken&&!this.tokenHasExpired()},e.prototype.http=function(b){var c=this,d=angular.extend({headers:{}},b);return c.accessToken&&(d.headers.Authorization="Bearer "+c.accessToken),a(d)},e.prototype.get=function(a,b){return this.http(angular.extend({method:"GET",url:a},b))},e.prototype.post=function(a,b,c){return this.http(angular.extend({method:"POST",url:a,data:b},c))},new e}]),angular.module("webappApp").controller("LoginCtrl",["$scope","$location",function(a,b){a.$watch("accessToken",function(){a.accessToken&&b.path("/")})}]),angular.module("webappApp").controller("DatasetListCtrl",["$scope","$location","GoogleApi",function(a,b,c){a.items=[],a.$watch("isSignedIn",function(){a.refreshList()}),a.refreshList=function(){a.items=[],a.accessToken&&c.get("https://www.googleapis.com/drive/v2/files",{params:{q:"not trashed and properties has { key = 'isWeightySheet' and value='true' and visibility='PUBLIC'}"}}).success(function(b){a.items=[],angular.forEach(b.items,function(b){a.items.push({title:b.title,id:b.id,createdDate:Date.parse(b.createdDate),modifiedDate:Date.parse(b.modifiedDate)})})})},a.create=function(){a.accessToken&&a.datasetName&&""!==a.datasetName&&(c.post("https://www.googleapis.com/drive/v2/files",{mimeType:"application/vnd.google-apps.spreadsheet",title:a.datasetName,properties:[{key:"isWeightySheet",value:!0,visibility:"PUBLIC"}]}).success(function(){a.refreshList()}),a.datasetName="")}}]),angular.module("webappApp").controller("LogoutCtrl",["$scope","$location","GoogleApi",function(a,b,c){c.logout(),b.path("/")}]),angular.module("webappApp").directive("waSidebar",function(){return{templateUrl:"partials/sidebar.html",restrict:"E"}}),angular.module("webappApp").controller("GoogleAccountCtrl",["$scope","GoogleApi",function(a,b){var c=function(){console.log("Google API token state changed"),console.log("Token:",b.accessToken),console.log("Signed in:",!!b.accessToken),a.accessToken=b.accessToken,a.accessTokenExpiry=b.expiryDate,a.isSignedIn=!!b.accessToken};a.$on("googleApiStateChanged",c),a.doLogin=function(){b.login()},a.doLogout=function(){b.logout()},a.$watch("isSignedIn",function(){return a.isSignedIn?void b.get("https://www.googleapis.com/plus/v1/people/me").success(function(b){a.me=b}):void(a.me=null)}),c()}]);